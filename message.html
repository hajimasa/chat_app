<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Devcha</title>
    <meta name="description" content="簡単にチャットするならDevcha"/>

    <!-- Bootstrap CSS / Color Scheme -->
    <link rel="stylesheet" href="css/default.css" id="theme-color">
</head>

<body>
<script type="text/javascript">

    var connection = "";

        console.log("コネクションを開始しします。");

        connection = new WebSocket('wss://3hbo79p2ab.execute-api.ap-northeast-1.amazonaws.com/develop');

        connection.onopen = function (e) {

            console.log("コネクションを開始しまいた。");

        };

        connection.onerror = function (error) {

            console.log("エラーが発生しました。");

        };

        connection.onmessage = function (e) {

            let msg = "メッセージを受信しました。" + e.data;

            const response = JSON.parse(e.data)
            console.log(response)

            const dateTime = new Date(response.posted_at)

            var dayOfWeek = dateTime.getDay()
            var dayOfWeekStr = [ "日", "月", "火", "水", "木", "金", "土" ][dayOfWeek] ;	// 曜日(日本語表記)

            const div = document.createElement('div')
            div.classList.add("rounded", "py-2", "px-3", "ml-3")

            const p = document.createElement("p")
            const ptext = document.createTextNode(`${response.user_name} ${dateTime.toLocaleDateString()}(${dayOfWeekStr}) ${dateTime.toLocaleTimeString('ja-JP')}`)
            p.appendChild(ptext)
            p.classList.add("p-0", "m-0")

            const span = document.createElement('span')
            const stext = document.createTextNode(response.message)
            span.appendChild(stext)

            div.appendChild(p)
            div.appendChild(span)

            const content = document.getElementById('chat-box')
            content.appendChild(div)

        };

        connection.onclose = function () {
            console.log("コネクションを終了しまいた。");
        };

    function snd_msg() {
      const name = document.getElementById("username").value
      const message = document.getElementById("message").value
      const room = getQueryRoomParam();

	    connection.send(JSON.stringify(
	      {
            action:"sendmessage",
            data:{
              room: room,
              name: name,
              message: message
            }
	      }
	    )
      );
      
      const messageinput = document.getElementById('message')
      messageinput.value = ""

    }

    function getQueryRoomParam() {
      var queryString = window.location.search;
      var queryObject = new Object();
      if (queryString) {
        queryString = queryString.substring(1);
        var parameters = queryString.split('&');
        for (var i = 0; i < parameters.length; i++) {
          var element = parameters[i].split('=');
          var paramName = decodeURIComponent(element[0]);
          var paramValue = decodeURIComponent(element[1]);
          queryObject[paramName] = paramValue;
        }
      }
      return queryObject.token;
    }

</script>

  <div class="container-fluid">
    <nav class="navbar navbar-expand-md navbar-dark">
        <a class="navbar-brand heading-black" href="index.html">Devcha</a>
    </nav>
  </div>

  <div class="content wrapper" id="chat-box">
  </div>

  <div class="flex-grow-0 py-3 px-4 bottom-box">
    <div class="input-group">
      <input type="text" class="form-control m-1" placeholder="名前" id="username">
      <input type="text" class="form-control m-1 w-50" placeholder="メッセージ" id="message">
      <button class="btn btn-primary m-1" onclick="snd_msg()">送信</button>
    </div>
  </div>

</div>

</html>
